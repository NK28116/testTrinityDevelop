# 基本設計書

## 1. システム構成

```
[開発者] ---(コード変更)---> [バージョン管理システム(例: GitHub)] ---(Webhook)---> [CI/CDツール(例: GitHub Actions)] ---(テスト実行)---> [テスト実行環境(Dockerコンテナ)] ---(テスト結果)---> [レポートツール(Allure)]
[テスト実行環境(Dockerコンテナ)] ---(テスト対象コード)---> [プロダクトコード]
```

**説明:**

1.  開発者がコードを変更し、バージョン管理システム(例: GitHub)にpushします。
2.  バージョン管理システムは、コードの変更を検知し、CI/CDツール(例: GitHub Actions)にWebhookを送信します。
3.  CI/CDツールは、Webhookを受け取り、テスト実行環境(Dockerコンテナ)を起動します。
4.  テスト実行環境は、指定されたテストケースを実行し、プロダクトコードの最小単位（ユニット、コンポーネントなど）をテストします。
5.  テスト実行環境は、テスト結果をレポートツール(Allure)に送信します。
6.  レポートツールは、テスト結果を可視化し、開発者に提供します。

## 2. 主要コンポーネント

### 2.1 テストケース定義コンポーネント
* 役割: テストケースの作成、編集、管理を行う。
* 責務:
    * テストケースを記述するためのUI/APIを提供する。
    * テストケースを永続化するためのストレージを提供する。
    * テストケースのバージョン管理を行う。

### 2.2 テスト実行コンポーネント
* 役割: テストケースを実行し、結果を収集する。
* 責務:
    * テスト対象のコードを特定する。
    * テストケースを実行するための環境を構築する。
    * テスト実行結果を収集し、フォーマットする。

### 2.3 レポートコンポーネント
* 役割: テスト結果を可視化し、分析を支援する。
* 責務:
    * テスト結果を整形し、見やすい形式で表示する。
    * テスト実行履歴を保存し、傾向を分析する。
    * カバレッジレポートを生成する。

### 2.4 CI/CD連携コンポーネント
* 役割: コード変更を検知し、自動的にテストを実行する。
* 責務:
    * バージョン管理システムからのWebhookを受け取る。
    * テスト実行コンポーネントを起動する。
    * テスト結果をレポートコンポーネントに送信する。

### 2.5 フロントエンド
*   UIコンポーネント：テストケース定義画面、テスト実行結果表示画面、レポート表示画面
*   状態管理：テストケースの状態、テスト実行の状態、レポートの状態
*   ルーティング：画面遷移の制御

### 2.6 バックエンド
*   APIサーバー：
    *   テストケースの作成、編集、削除API
    *   テスト実行API
    *   テスト結果取得API
    *   レポート生成API
*   ビジネスロジック：
    *   テストケースの検証
    *   テスト実行の制御
    *   レポートの生成
*   認証：
    *   開発者の認証
    *   APIの認可

### 2.7 データ層
*   データベース：
    *   テストケース
    *   テスト結果
    *   テスト実行履歴
*   キャッシュ：
    *   テストケース (テスト実行時に高速化)
    *   テスト結果 (レポート表示時に高速化)
*   ストレージ：
    *   テスト実行ログ
    *   カバレッジレポート

## 3. データ構造

```
[TestCase] 1--* [TestResult]
[TestCase] 1--1 [TestCode]
[TestResult] 1--1 [TestCode]
```

**説明:**

*   **TestCase:** テストケースを定義するエンティティ。ID、テスト名、テスト対象の関数名、入力データ、期待される出力、検証方法などの属性を持つ。
*   **TestResult:** テストケースの実行結果を記録するエンティティ。ID、テストケースID、実行日時、実行時間、ステータス（成功/失敗）、エラーメッセージ、スタックトレースなどの属性を持つ。
*   **TestCode:** テスト対象のコードを特定するエンティティ。 関数名、クラス名、モジュール名などの属性を持つ。

## 4. API定義

| メソッド | エンドポイント         | 説明                                                                         |
| -------- | ---------------------- | ---------------------------------------------------------------------------- |
| POST     | /api/testcases        | 新しいテストケースを作成する                                                   |
| GET      | /api/testcases/{id}    | 特定のIDを持つテストケースを取得する                                           |
| PUT      | /api/testcases/{id}    | 特定のIDを持つテストケースを更新する                                           |
| DELETE   | /api/testcases/{id}    | 特定のIDを持つテストケースを削除する                                           |
| POST     | /api/tests/run        | 指定されたテストケースを実行する。リクエストボディでテストケースIDを指定する。 |
| GET      | /api/tests/results/{id} | 特定のテスト実行結果を取得する                                                   |
| GET      | /api/reports/coverage | テストカバレッジレポートを取得する                                             |

## 5. 技術選定理由

*   **プログラミング言語:** Python
    *   理由：テストフレームワーク（pytest）の充実度が高く、自動化に適している。
*   **テストフレームワーク:** pytest
    *   理由：柔軟性、拡張性が高く、豊富なプラグインが利用可能。アサーションリライト機能が便利。
*   **CI/CDツール:** GitHub Actions
    *   理由：GitHubとの連携が容易であり、設定が比較的簡単。
*   **レポートツール:** Allure Framework
    *   理由：テスト結果を綺麗に可視化できる。テストの傾向分析にも役立つ。
*   **インフラ:** Docker, Kubernetes (必要に応じて)
    *   理由：テスト実行環境の再現性を保証し、スケーラビリティを向上させる。

## 6. セキュリティ設計

*   **認証・認可:**
    *   APIへのアクセスは認証を必須とする。開発者ごとにAPIキーを発行し、APIリクエスト時に認証を行う。
    *   ロールベースの認可を実装し、開発者ごとに権限を付与する。
*   **データ保護:**
    *   テストケース、テスト結果などの機密データは暗号化して保存する。
    *   HTTPSを使用して、API通信を暗号化する。
    *   入力値の検証を徹底し、SQLインジェクションやクロスサイトスクリプティングなどの脆弱性対策を行う。
*   **テスト環境の隔離:**
    * 本番環境に影響を与えないよう、テスト環境は本番環境から完全に隔離する。
    * テストデータは、本番環境のデータを使用せず、ダミーデータを使用する。

## 7. 非機能要件への対応

*   **パフォーマンス:**
    *   テスト実行時間を短縮するために、テストケースを最適化する。
    *   テスト実行環境に十分なリソースを割り当てる。
    *   キャッシュを活用して、テスト結果の表示を高速化する。
*   **スケーラビリティ:**
    *   Docker, Kubernetesを活用して、テスト実行環境をスケールアウト可能にする。
    *   データベースをスケールアウト可能にする。
*   **可用性:**
    *   テスト実行環境を冗長化する。
    *   データベースを冗長化する。
    *   障害発生時に自動的にフェイルオーバーする仕組みを構築する。
